name: Build and Push GCP Marketplace Images

on:
  push:
    tags:
      - '*.*.*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 2026.1.0)'
        required: true
        type: string
      channel:
        description: 'Release channel'
        required: true
        type: string
        default: 'stable'

env:
  REGISTRY: gcr.io
  PROJECT_ID: gitguardian-public
  REPOSITORY: gitguardian-wrapper
  GCP_MARKETPLACE_SERVICE: services/gitguardian.endpoints.gitguardian-public.cloud.goog

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version and channel
        id: version
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, use a test version and don't push
            VERSION="pr-${{ github.event.pull_request.number }}"
            CHANNEL="test"
            PUSH="false"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
            CHANNEL="${{ inputs.channel }}"
            PUSH="true"
          else
            # Extract version from tag (e.g., 2026.1.0)
            VERSION="${GITHUB_REF#refs/tags/}"
            CHANNEL="stable"
            PUSH="true"
          fi

          # Extract major.minor from version (e.g., 2026.1.0 -> 2026.1)
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major_minor=$MAJOR_MINOR" >> $GITHUB_OUTPUT
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "push=$PUSH" >> $GITHUB_OUTPUT

          echo "Building version: $VERSION"
          echo "Major.Minor: $MAJOR_MINOR"
          echo "Channel: $CHANNEL"
          echo "Push to registry: $PUSH"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as credential helper
        run: |
          gcloud auth configure-docker gcr.io

      - name: Install yq
        uses: frenck/action-setup-yq@v1

      - name: Update version in source files
        run: |
          # Update version in Chart.yaml, values.yaml, and schema.yaml
          # This must be done BEFORE docker build because the base image's ONBUILD
          # triggers package the chart before our Dockerfile commands run
          yq eval '.version = "${{ steps.version.outputs.version }}"' -i chart/gim/Chart.yaml
          yq eval '.channel = "${{ steps.version.outputs.channel }}"' -i chart/gim/values.yaml
          yq eval '.x-google-marketplace.publishedVersion = "${{ steps.version.outputs.version }}"' -i schema.yaml

          echo "Updated versions:"
          echo "  Chart.yaml version: $(yq eval '.version' chart/gim/Chart.yaml)"
          echo "  values.yaml channel: $(yq eval '.channel' chart/gim/values.yaml)"
          echo "  schema.yaml publishedVersion: $(yq eval '.x-google-marketplace.publishedVersion' schema.yaml)"

      - name: Build and push deployer image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ steps.version.outputs.push == 'true' }}
          load: ${{ steps.version.outputs.push == 'false' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:${{ steps.version.outputs.major_minor }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:latest
          platforms: linux/amd64
          annotations: |
            com.googleapis.cloudmarketplace.product.service.name=${{ env.GCP_MARKETPLACE_SERVICE }}
          # Disable provenance attestations - GCP Marketplace doesn't support OCI image index format
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install crane
        if: steps.version.outputs.push == 'true'
        uses: imjasonh/setup-crane@v0.4

      - name: Tag wrapper image with new version
        if: steps.version.outputs.push == 'true'
        run: |
          # The wrapper image is always the same (FROM scratch)
          # Copy from latest and add GCP Marketplace annotation
          for TAG in "${{ steps.version.outputs.version }}" "${{ steps.version.outputs.major_minor }}"; do
            crane copy \
              "${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:latest" \
              "${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:${TAG}"
            crane mutate \
              "${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:${TAG}" \
              --annotation "com.googleapis.cloudmarketplace.product.service.name=${{ env.GCP_MARKETPLACE_SERVICE }}"
          done

      - name: Output image URIs (Push)
        if: steps.version.outputs.push == 'true'
        run: |
          echo "‚úÖ Images built and pushed successfully!"
          echo ""
          echo "üì¶ Channel: ${{ steps.version.outputs.channel }}"
          echo "üèóÔ∏è  Architecture: linux/amd64"
          echo ""
          echo "üöÄ Deployer image (built):"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:${{ steps.version.outputs.version }}"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:${{ steps.version.outputs.major_minor }}"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/deployer:latest"
          echo ""
          echo "üè∑Ô∏è  Wrapper image (tagged from latest):"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:${{ steps.version.outputs.version }}"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:${{ steps.version.outputs.major_minor }}"
          echo "  ‚Ä¢ ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}:latest"

      - name: Output build status (PR)
        if: steps.version.outputs.push == 'false'
        run: |
          echo "‚úÖ Deployer image built successfully (not pushed - PR validation only)"
          echo ""
          echo "üì¶ Channel: ${{ steps.version.outputs.channel }}"
          echo "üèóÔ∏è  Architecture: linux/amd64"
          echo ""
          echo "üî® Deployer image: Built locally for validation"
          echo "‚è≠Ô∏è  Wrapper image: Skipped (FROM scratch - nothing to validate)"
          echo ""
          echo "‚ÑπÔ∏è  Deployer image loaded locally for validation but not pushed to registry."
